#include "can.h" 
#include "FreeRTOS.h"
#include "task.h"
#include "queue.h"
#include "semphr.h"
#include "rfifo.h"
#include <stdio.h>

extern Ringfifo 					canfifo;
extern TaskHandle_t 			pxCanTask;
////////////////////////////////////////////////////////////////////////////////// 	 

uint16_t Can1IdFiter[]={0x0320,0x0321,0x031D,0x042B,0x0420,0x0318,0x031C,0x03C0,0x0330,
0x0345, 0x0338, 0x0348, 0x0307, 0x0325, 0x033A, 0x0336, 0x0393, 0x0340, 0x034B, 0x0353,
0x0352, 0x031E, 0x0428, 0x0265, 0x004D, 0x031F, 0x0436};

uint16_t Can2IdFiter[]={0x0320,0x0321,0x031D,0x042B,0x0420,0x0318,0x031C,0x03C0,0x0330,
0x0345, 0x0338, 0x0348, 0x0307, 0x0325, 0x033A, 0x0336, 0x0393, 0x0340, 0x034B, 0x0353,
0x0352, 0x031E, 0x0428, 0x0265, 0x004D, 0x031F, 0x0436};



Filter_config Fitler_Config={
         
  	(sizeof(Can1IdFiter)/sizeof(uint16_t)),//1y??can1¦Ì?id??¨ºy¡ê?¡Á??¨¤2?2¨´1y4*14=56
	 Can1IdFiter,//1y??¦Ì?ido?
	(sizeof(Can2IdFiter)/sizeof(uint16_t)),//1y??can2¦Ì?id??¨ºy¡ê?¡Á??¨¤2?2¨´1y4*14=56
	 Can2IdFiter,
	 TurnOn//??2¡§¡ä¨°?a
};

//¡Á¨¹1228????2¡§?¡Â¡Á¨¦¡ê?0-13¡¤?????fifi0 ¡ê?14-27¡¤?????fifi1
//¨®¨¦¨®¨²CAN2¦Ì???2¡§¨¦¨¨??¨º??¨´?YCAN1¨¤¡ä¨¦¨¨??¡ê??¨´¨°?3?¨º??¡¥¦Ì?¨º¡Ào¨°??2¡§??D¨¨¨¦¨¨??¨°?¡ä?
//??2¡§?y¨¨¡¤¨¦¨¨??¡¤¦Ì??0¡ê?¨¦¨¨??¨º¡ì¡ã¨¹¡¤¦Ì??1¡ê?
uint8_t CAN_FilterSet(Filter_config *fitler_cfg)
{
	uint8_t i,j=0;
	CAN_FilterInitTypeDef  CAN_FilterInitStructure;
	if(fitler_cfg->filter_switch==TurnOn)//??2¡§?¡Â¡ä¨°?a
	{
			CAN1->FMR |= 1;//1y???¡Â¡Á¨¦1¡è¡Á¡Â?¨²3?¨º??¡¥?¡ê¨º?    
			CAN1->FMR &= 0xffffc0ff;//can2¦Ì?1y???¡Â¡ä¨®14?a¨º? 
			CAN1->FMR |= (14<<8); 
			CAN1->FFA1R = 0x0fffc000;//0--13o?1y??¡Á¨¦1?¨¢a¦Ì?fifi0¡ê?14--271?¨¢a¦Ì?fifi1
			if(fitler_cfg->sum_can1_id<=56&&fitler_cfg->sum_can1_id<=56)
			{	
					for(i=0,j=0;i<fitler_cfg->sum_can1_id;i++)
					{
							CAN1->FM1R |= (1<<i);//1y???¡Â¡Á¨¦i¦Ì???¡ä??¡Â¡Á¨¦1¡è¡Á¡Â?¨²¨¢D¡À¨ª?¡ê¨º?,¨°???1y??¡Á¨¦¨¦¨¨??????¡À¨º¡Á?????2¡§id  
																	 //???¨ª?a16??¡ê?2??32??¡¤??a????16????¡ä??¡Â¡ê?1y??                                                
							CAN1->FA1R &= ~(1<<i);//??¨®?1y??¡Á¨¦i
								
							CAN1->sFilterRegister[i].FR1 &= 0x00000000;   
							CAN1->sFilterRegister[i].FR1 =(((uint32_t)(*fitler_cfg->can1_id)|CAN_ID_STD|CAN_RTR_DATA)<<21)&0xffff0000; 
							if(++j==fitler_cfg->sum_can1_id)
							 {
									CAN1->sFilterRegister[i].FR1 |= ((((uint32_t)(*fitler_cfg->can1_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
									CAN1->FA1R |= (1<<i);
									break;
							 }//¨º1?¨¹1y???¡Â¡Á¨¦i			
							fitler_cfg->can1_id++;
							CAN1->sFilterRegister[i].FR1 |= ((((uint32_t)(*fitler_cfg->can1_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
							if(++j==fitler_cfg->sum_can1_id)	{CAN1->FA1R |= (1<<i);break;}//¨º1?¨¹1y???¡Â¡Á¨¦i	
							fitler_cfg->can1_id++;  
							CAN1->sFilterRegister[i].FR2 &= 0x00000000; 
							CAN1->sFilterRegister[i].FR2 = (((uint32_t)(*fitler_cfg->can1_id)|CAN_ID_STD|CAN_RTR_DATA)<<21)&0xffff0000; 
							if(++j==fitler_cfg->sum_can1_id)	
							 {
									 CAN1->sFilterRegister[i].FR2 |= ((((uint32_t)(*fitler_cfg->can1_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
									 CAN1->FA1R |= (1<<i);
									 break;
							 }//¨º1?¨¹1y???¡Â¡Á¨¦i	
							fitler_cfg->can1_id++;    
							CAN1->sFilterRegister[i].FR2 |= ((((uint32_t)(*fitler_cfg->can1_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
							if(++j==fitler_cfg->sum_can1_id)	{CAN1->FA1R |= (1<<i);break;}//¨º1?¨¹1y???¡Â¡Á¨¦i						
							fitler_cfg->can1_id++; 
							
							CAN1->FA1R |= (1<<i);//¨º1?¨¹1y???¡Â¡Á¨¦i   
					}
					
					
					for(i=14,j=14;i<fitler_cfg->sum_can2_id+14;i++)
					{
							CAN1->FM1R |= (1<<i);//1y???¡Â¡Á¨¦i¦Ì???¡ä??¡Â¡Á¨¦1¡è¡Á¡Â?¨²¨¢D¡À¨ª?¡ê¨º?  
																	 //???¨ª?a16??¡ê?2??32??¡¤??a????16????¡ä??¡Â¡ê?1y??                                                
							CAN1->FA1R &= ~(1<<i);//??¨®?1y??¡Á¨¦i
								
							CAN1->sFilterRegister[i].FR1 &= 0x00000000;  
							CAN1->sFilterRegister[i].FR1 =(((uint32_t)(*fitler_cfg->can2_id)|CAN_ID_STD|CAN_RTR_DATA)<<21)&0xffff0000;
							if(++j==fitler_cfg->sum_can2_id+14)	
							 {
								 CAN1->sFilterRegister[i].FR1 |= ((((uint32_t)(*fitler_cfg->can2_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
								 CAN1->FA1R |= (1<<i);
								 break;
							 }//¨º1?¨¹1y???¡Â¡Á¨¦i			
							fitler_cfg->can2_id++;
							CAN1->sFilterRegister[i].FR1 |= ((((uint32_t)(*fitler_cfg->can2_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
							if(++j==fitler_cfg->sum_can2_id+14)	{CAN1->FA1R |= (1<<i);break;}//¨º1?¨¹1y???¡Â¡Á¨¦i	
							fitler_cfg->can2_id++; 
							CAN1->sFilterRegister[i].FR2 &= 0x00000000;  					
							CAN1->sFilterRegister[i].FR2 = (((uint32_t)(*fitler_cfg->can2_id)|CAN_ID_STD|CAN_RTR_DATA)<<21)&0xffff0000;
							if(++j==fitler_cfg->sum_can2_id+14)	
							 {
									 CAN1->sFilterRegister[i].FR2 |= ((((uint32_t)(*fitler_cfg->can2_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
									 CAN1->FA1R |= (1<<i);
									 break;
							 }//¨º1?¨¹1y???¡Â¡Á¨¦i	
							fitler_cfg->can2_id++;    
							CAN1->sFilterRegister[i].FR2 |= ((((uint32_t)(*fitler_cfg->can2_id)|CAN_ID_STD|CAN_RTR_DATA)<<5)&0x0000ffff);
							if(++j==fitler_cfg->sum_can2_id+14)	{CAN1->FA1R |= (1<<i);break;}//¨º1?¨¹1y???¡Â¡Á¨¦i						
							fitler_cfg->can2_id++; 
							
							CAN1->FA1R |= (1<<i);//¨º1?¨¹1y???¡Â¡Á¨¦i   
					}

				}
				else return 1;
				
				CAN1->FMR &= ~1; //1y???¡Â?y3¡ê1¡è¡Á¡Â
	}	
	else//?¨®¨º??¨´¨®Did
	{	
		    /* ¨¦¨¨??CAN ¨¦????¡Â0 */
				CAN_FilterInitStructure.CAN_FilterNumber = 0;		/*  ¨¦????¡ÂD¨°o?¡ê?0-13¡ê?1214????2¡§?¡Â */
				CAN_FilterInitStructure.CAN_FilterMode = CAN_FilterMode_IdMask;		/* ¨¦????¡Â?¡ê¨º?¡ê?¨¦¨¨??ID?¨²???¡ê¨º? */
				CAN_FilterInitStructure.CAN_FilterScale = CAN_FilterScale_32bit;	/* 32??¨¦????¡Â */
				CAN_FilterInitStructure.CAN_FilterIdHigh = 0x0000;					/* ?¨²??o¨®ID¦Ì???16bit */
				CAN_FilterInitStructure.CAN_FilterIdLow = 0x0000;					/* ?¨²??o¨®ID¦Ì?¦Ì¨ª16bit */
				CAN_FilterInitStructure.CAN_FilterMaskIdHigh = 0x0000;				/* ID?¨²???¦Ì??16bit */
				CAN_FilterInitStructure.CAN_FilterMaskIdLow = 0x0000;				/* ID?¨²???¦Ì¦Ì¨ª16bit */
				CAN_FilterInitStructure.CAN_FilterFIFOAssignment = CAN_FIFO0;		/* ¨¦????¡Â¡ã¨®?¡§FIFO 0 */
				CAN_FilterInitStructure.CAN_FilterActivation = ENABLE;				/* ¨º1?¨¹¨¦????¡Â */
				CAN_FilterInit(&CAN_FilterInitStructure);
					
				/* ¨¦¨¨??CAN¨¦????¡ÂD¨°o?14 ¡ê?CAN2¨¦????¡ÂD¨°o? 14--27¡ê???CAN1¦Ì?¨º?0--13*/
				CAN_FilterInitStructure.CAN_FilterNumber = 16;						/* ¨¦????¡ÂD¨°o?¡ê?14-27¡ê?1214????2¡§?¡Â */
				CAN_FilterInitStructure.CAN_FilterMode = CAN_FilterMode_IdMask;		/* ¨¦????¡Â?¡ê¨º?¡ê?¨¦¨¨??ID?¨²???¡ê¨º? */
				CAN_FilterInitStructure.CAN_FilterScale = CAN_FilterScale_32bit;	/* 32??¨¦????¡Â */
				CAN_FilterInitStructure.CAN_FilterIdHigh = 0x0000;					/* ?¨²??o¨®ID¦Ì???16bit */
				CAN_FilterInitStructure.CAN_FilterIdLow = 0x0000;					/* ?¨²??o¨®ID¦Ì?¦Ì¨ª16bit */
				CAN_FilterInitStructure.CAN_FilterMaskIdHigh = 0x0000;				/* ID?¨²???¦Ì??16bit */
				CAN_FilterInitStructure.CAN_FilterMaskIdLow = 0x0000;				/* ID?¨²???¦Ì¦Ì¨ª16bit */
				CAN_FilterInitStructure.CAN_FilterFIFOAssignment = CAN_FIFO1;		/*  ¨¦????¡Â¡ã¨®?¡§FIFO 1 */
				CAN_FilterInitStructure.CAN_FilterActivation = ENABLE;				/* ¨º1?¨¹¨¦????¡Â */
				CAN_FilterInit(&CAN_FilterInitStructure);	
	  }
    return 0;

}


u16 CAN1_RX_STA=0;

u8 CAN1_Mode_Init(u8 tsjw,u8 tbs2,u8 tbs1,u16 brp,u8 mode)
{

  	GPIO_InitTypeDef GPIO_InitStructure; 
	  CAN_InitTypeDef        CAN_InitStructure;
//  	CAN_FilterInitTypeDef  CAN_FilterInitStructure;
#if CAN1_RX0_INT_ENABLE 
   	NVIC_InitTypeDef  NVIC_InitStructure;
#endif
    //¨º1?¨¹?¨¤1?¨º¡À?¨®
	  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE);//¨º1?¨¹PORTA¨º¡À?¨®	                   											 

  	RCC_APB1PeriphClockCmd(RCC_APB1Periph_CAN1, ENABLE);//¨º1?¨¹CAN1¨º¡À?¨®	
	
    //3?¨º??¡¥GPIO
	  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9| GPIO_Pin_8;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;//?¡ä¨®?1|?¨¹
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//¨ª?¨ª¨¬¨º?3?
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;//¨¦?¨¤-
    GPIO_Init(GPIOB, &GPIO_InitStructure);//3?¨º??¡¥PA11,PA12
	
	  //¨°y???¡ä¨®?¨®3¨¦?????
	  GPIO_PinAFConfig(GPIOB,GPIO_PinSource9,GPIO_AF_CAN1); //GPIOA11?¡ä¨®??aCAN1
	  GPIO_PinAFConfig(GPIOB,GPIO_PinSource8,GPIO_AF_CAN1); //GPIOA12?¡ä¨®??aCAN1
	  
  	//CAN¦Ì£¤?a¨¦¨¨??
		CAN_DeInit(CAN1); //lex
   	CAN_InitStructure.CAN_TTCM=DISABLE;	//¡¤?¨º¡À??¡ä£¤¡¤¡é¨ª¡§D??¡ê¨º?   
  	CAN_InitStructure.CAN_ABOM=DISABLE;	//¨¨¨ª?t¡Á??¡¥¨¤???1¨¹¨¤¨ª	  
  	CAN_InitStructure.CAN_AWUM=DISABLE;//?¡¥???¡ê¨º?¨ª¡§1y¨¨¨ª?t??D?(??3yCAN->MCR¦Ì?SLEEP??)
  	CAN_InitStructure.CAN_NART=DISABLE;	//???1¡À¡§??¡Á??¡¥¡ä??¨ª 
  	CAN_InitStructure.CAN_RFLM=DISABLE;	//¡À¡§??2????¡§,D?¦Ì??2???¨¦¦Ì?  
  	CAN_InitStructure.CAN_TXFP=DISABLE;	//¨®??¨¨??¨®¨¦¡À¡§??¡À¨º¨º?¡¤????¡§ 
  	CAN_InitStructure.CAN_Mode= mode;	 //?¡ê¨º?¨¦¨¨?? 
  	CAN_InitStructure.CAN_SJW=tsjw;	//??D?¨ª?2?¨¬????¨ª?¨¨(Tsjw)?atsjw+1??¨º¡À??¦Ì£¤?? CAN_SJW_1tq~CAN_SJW_4tq
  	CAN_InitStructure.CAN_BS1=tbs1; //Tbs1¡¤??¡ìCAN_BS1_1tq ~CAN_BS1_16tq
  	CAN_InitStructure.CAN_BS2=tbs2;//Tbs2¡¤??¡ìCAN_BS2_1tq ~	CAN_BS2_8tq
  	CAN_InitStructure.CAN_Prescaler=brp;  //¡¤??¦Ì?¦Ì¨ºy(Fdiv)?abrp+1	
  	CAN_Init(CAN1, &CAN_InitStructure);   // 3?¨º??¡¥CAN1 
    
		//????1y???¡Â
/*		
 	  CAN_FilterInitStructure.CAN_FilterNumber=0;	  //1y???¡Â0
  	CAN_FilterInitStructure.CAN_FilterMode=CAN_FilterMode_IdMask; 
  	CAN_FilterInitStructure.CAN_FilterScale=CAN_FilterScale_32bit; //32?? 
  	CAN_FilterInitStructure.CAN_FilterIdHigh=0x0000;////32??ID  0x0000 lex change
  	CAN_FilterInitStructure.CAN_FilterIdLow=0x0000;
  	CAN_FilterInitStructure.CAN_FilterMaskIdHigh=0x0000;//32??MASK
  	CAN_FilterInitStructure.CAN_FilterMaskIdLow=0x0000;
   	CAN_FilterInitStructure.CAN_FilterFIFOAssignment=CAN_Filter_FIFO0;//1y???¡Â01?¨¢a¦Ì?FIFO0
  	CAN_FilterInitStructure.CAN_FilterActivation=ENABLE; //?¡è??1y???¡Â0
  	CAN_FilterInit(&CAN_FilterInitStructure);//??2¡§?¡Â3?¨º??¡¥
*/
		CAN_FilterSet(&Fitler_Config);
		
#if CAN1_RX0_INT_ENABLE
	
	  CAN_ITConfig(CAN1,CAN_IT_FMP0,ENABLE);//FIFO0???¡é1¨°o??D???¨ºD¨ª.		    
  
  	NVIC_InitStructure.NVIC_IRQChannel = CAN1_RX0_IRQn;
  	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2;     // ?¡Â¨®??¨¨???a1
  	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;            // ¡ä?¨®??¨¨???a0
  	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
  	NVIC_Init(&NVIC_InitStructure);
#endif
	return 0;
}   
 
#if CAN1_RX0_INT_ENABLE	//¨º1?¨¹RX0?D??
//?D??¡¤t??o¡¥¨ºy		
long num_can1_IRQ = 0;

void CAN1_RX0_IRQHandler(void)
{
	CanRxMsg RxMessage;
	struct rfifo *fifo = &canfifo;
	num_can1_IRQ++;

	(void) vPortEnterCritical();
	
	CAN_Receive(CAN1, 0, &RxMessage);
	while( fifo->size - rfifo_len( fifo ) < sizeof(unsigned int) + sizeof(unsigned char)*8 )
	{

		printf("can fifo error!\r\n");
		(void) vPortExitCritical();				
		return;
	}

	if (RxMessage.IDE == CAN_Id_Standard)
	{
		rfifo_put(fifo, &RxMessage.StdId, sizeof(unsigned int));
		rfifo_put(fifo, RxMessage.Data, sizeof(unsigned char)*8);
		if( pxCanTask )
		{
			vTaskNotifyGiveFromISR( pxCanTask, NULL );		
			
		}			
		
		//xSemaphoreGiveFromISR(xDownStreamSemaphore, NULL);
	}	
	
	(void) vPortExitCritical();				

}
#endif


u8 CAN1_Send_Msg(u8* msg,u8 len)
{	
//id:¡À¨º¡Á?ID(11??)/¨¤??1ID(11??+18??)	    
//ide:0,¡À¨º¡Á???;1,¨¤??1??
//rtr:0,¨ºy?Y??;1,??3¨¬??
//len:¨ºy?Y3¡è?¨¨
//msg:¨ºy?Y?o¡ä???	
  u8 mbox;
  u16 i=0;
  CanTxMsg TxMessage;
  TxMessage.StdId=0x12;	 // ¡À¨º¡Á?¡À¨º¨º?¡¤??a0 			11bit   0x712
  TxMessage.ExtId=0x12;	 // ¨¦¨¨??¨¤??1¡À¨º¨º?¡¤?¡ê¡§29??¡ê?
  TxMessage.IDE=0;		  // ¨º1¨®?¨¤??1¡À¨º¨º?¡¤?
  TxMessage.RTR=0;		  // ???¡é¨¤¨¤D¨ª?a¨ºy?Y??¡ê?¨°???8??
  TxMessage.DLC=len;							 // ¡¤¡é?¨ª¨¢???D??¡é
  for(i=0;i<len;i++)
  TxMessage.Data[i]=msg[i];				 // ¦Ì¨²¨°???D??¡é          
  mbox= CAN_Transmit(CAN1, &TxMessage);   
  i=0;
  while((CAN_TransmitStatus(CAN1, mbox)==CAN_TxStatus_Failed)&&(i<0XFFF))i++;	//¦Ì¨¨¡äy¡¤¡é?¨ª?¨¢¨º?
  if(i>=0XFFF)return 1;
  return 0;		

}

u8 CAN1_Send_Msg1(uint32_t id, u8* msg,u8 len)
{	
//id:¡À¨º¡Á?ID(11??)/¨¤??1ID(11??+18??)	    
//ide:0,¡À¨º¡Á???;1,¨¤??1??
//rtr:0,¨ºy?Y??;1,??3¨¬??
//len:¨ºy?Y3¡è?¨¨
//msg:¨ºy?Y?o¡ä???	
  u8 mbox;
  u16 i=0;
  CanTxMsg TxMessage;
  TxMessage.StdId=id;	 // ¡À¨º¡Á?¡À¨º¨º?¡¤??a0 			11bit   0x712
  TxMessage.ExtId=0x12;	 // ¨¦¨¨??¨¤??1¡À¨º¨º?¡¤?¡ê¡§29??¡ê?
  TxMessage.IDE=0;		  // ¨º1¨®?¨¤??1¡À¨º¨º?¡¤?
  TxMessage.RTR=0;		  // ???¡é¨¤¨¤D¨ª?a¨ºy?Y??¡ê?¨°???8??
  TxMessage.DLC=len;							 // ¡¤¡é?¨ª¨¢???D??¡é
  for(i=0;i<len;i++)
  TxMessage.Data[i]=msg[i];				 // ¦Ì¨²¨°???D??¡é          
  mbox= CAN_Transmit(CAN1, &TxMessage);   
  i=0;
  while((CAN_TransmitStatus(CAN1, mbox)==CAN_TxStatus_Failed)&&(i<0XFFF))i++;	//¦Ì¨¨¡äy¡¤¡é?¨ª?¨¢¨º?
  if(i>=0XFFF)return 1;
  return 0;		

}

u8 CAN1_Send_Msg2(uint32_t id, uint8_t ide, uint8_t rtr, u8* msg,u8 len)
{	
//id:¡À¨º¡Á?ID(11??)/¨¤??1ID(11??+18??)	    
//ide:0,¡À¨º¡Á???;1,¨¤??1??
//rtr:0,¨ºy?Y??;1,??3¨¬??
//len:¨ºy?Y3¡è?¨¨
//msg:¨ºy?Y?o¡ä???	
  u8 mbox;
  u16 i=0;
  CanTxMsg TxMessage;
  TxMessage.StdId=id;	 // ¡À¨º¡Á?¡À¨º¨º?¡¤??a0 			11bit   0x712
  TxMessage.ExtId=id;	 // ¨¦¨¨??¨¤??1¡À¨º¨º?¡¤?¡ê¡§29??¡ê?
  TxMessage.IDE=ide;		  // ¨º1¨®?¨¤??1¡À¨º¨º?¡¤?
  TxMessage.RTR=rtr;		  // ???¡é¨¤¨¤D¨ª?a¨ºy?Y??¡ê?¨°???8??
  TxMessage.DLC=len;							 // ¡¤¡é?¨ª¨¢???D??¡é
  for(i=0;i<len;i++)
  TxMessage.Data[i]=msg[i];				 // ¦Ì¨²¨°???D??¡é          
  mbox= CAN_Transmit(CAN1, &TxMessage);   
  i=0;
  while((CAN_TransmitStatus(CAN1, mbox)==CAN_TxStatus_Failed)&&(i<0XFFF))i++;	//¦Ì¨¨¡äy¡¤¡é?¨ª?¨¢¨º?
  if(i>=0XFFF)return 1;
  return 0;		

}
//can?¨²?¨®¨º?¨ºy?Y2¨¦?¡¥
//buf:¨ºy?Y?o¡ä???;	 
//¡¤¦Ì???¦Ì:0,?T¨ºy?Y¡À?¨º?¦Ì?;
//		 ????,?¨®¨º?¦Ì?¨ºy?Y3¡è?¨¨;
u8 CAN1_Receive_Msg(u8 *buf)
{		   		   
 	u32 i;
	CanRxMsg RxMessage;
    if( CAN_MessagePending(CAN1,CAN_FIFO0)==0)return 0;		//??¨®D?¨®¨º?¦Ì?¨ºy?Y,?¡À?¨®¨ª?3? 
    CAN_Receive(CAN1, CAN_FIFO0, &RxMessage);//?¨¢¨¨?¨ºy?Y	
    for(i=0;i<RxMessage.DLC;i++)
    buf[i]=RxMessage.Data[i];  
	return RxMessage.DLC;	
}

/************************************CAN2****************************************************/
/*************************************CAN2***************************************************/
/*************************************CAN2***************************************************/
/************************************CAN2****************************************************/
/***********************************CAN2*CAN2************************************************/
/************************************CAN2****************************************************/
/************************************CAN2****************************************************/
/************************************CAN2****************************************************/
/*************************************CAN2***************************************************/

u16 CAN2_RX_STA=0;

u8 CAN2_Mode_Init(u8 tsjw,u8 tbs2,u8 tbs1,u16 brp,u8 mode)
{

  	GPIO_InitTypeDef GPIO_InitStructure; 
	  CAN_InitTypeDef        CAN_InitStructure;
//  	CAN_FilterInitTypeDef  CAN_FilterInitStructure;
#if CAN2_RX0_INT_ENABLE 
   	NVIC_InitTypeDef  NVIC_InitStructure;
#endif
    //¨º1?¨¹?¨¤1?¨º¡À?¨®
	  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE);
	  //¨º1?¨¹PORTB¨º¡À?¨®	 PB5=CAN2_RX    PB6=CAN2_TX                  											 

  	RCC_APB1PeriphClockCmd(RCC_APB1Periph_CAN1 | RCC_APB1Periph_CAN2, ENABLE);//¨º1?¨¹CAN2¨º¡À?¨®	
	
    //3?¨º??¡¥GPIO
	  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5| GPIO_Pin_6; 
	  //GPIO_Pin_5 GPIO_Pin_6| GPIO_Pin_12 GPIO_Pin_13;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;//?¡ä¨®?1|?¨¹
    GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;//¨ª?¨ª¨¬¨º?3?
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;//100MHz
    GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP;//¨¦?¨¤-
    GPIO_Init(GPIOB, &GPIO_InitStructure);//3?¨º??¡¥PA11,PA12
	
	  //¨°y???¡ä¨®?¨®3¨¦?????
	  GPIO_PinAFConfig(GPIOB, GPIO_PinSource5, GPIO_AF_CAN2); //GPIOA5?¡ä¨®??aCAN2
	  GPIO_PinAFConfig(GPIOB, GPIO_PinSource6, GPIO_AF_CAN2); //GPIOA12?¡ä¨®??aCAN2
	  
  	//CAN¦Ì£¤?a¨¦¨¨??
		CAN_DeInit(CAN2);
   	CAN_InitStructure.CAN_TTCM=DISABLE;	//¡¤?¨º¡À??¡ä£¤¡¤¡é¨ª¡§D??¡ê¨º?   
  	CAN_InitStructure.CAN_ABOM=DISABLE;	//¨¨¨ª?t¡Á??¡¥¨¤???1¨¹¨¤¨ª	  
  	CAN_InitStructure.CAN_AWUM=DISABLE;//?¡¥???¡ê¨º?¨ª¡§1y¨¨¨ª?t??D?(??3yCAN->MCR¦Ì?SLEEP??)
  	CAN_InitStructure.CAN_NART=DISABLE;	//???1¡À¡§??¡Á??¡¥¡ä??¨ª ///////LEXLEXLEX
  	CAN_InitStructure.CAN_RFLM=DISABLE;	//¡À¡§??2????¡§,D?¦Ì??2???¨¦¦Ì?  
  	CAN_InitStructure.CAN_TXFP=DISABLE;	//¨®??¨¨??¨®¨¦¡À¡§??¡À¨º¨º?¡¤????¡§ 
  	CAN_InitStructure.CAN_Mode= mode;	 //?¡ê¨º?¨¦¨¨?? 
  	CAN_InitStructure.CAN_SJW=tsjw;	//??D?¨ª?2?¨¬????¨ª?¨¨(Tsjw)?atsjw+1??¨º¡À??¦Ì£¤?? CAN_SJW_1tq~CAN_SJW_4tq
  	CAN_InitStructure.CAN_BS1=tbs1; //Tbs1¡¤??¡ìCAN_BS1_1tq ~CAN_BS1_16tq
  	CAN_InitStructure.CAN_BS2=tbs2;//Tbs2¡¤??¡ìCAN_BS2_1tq ~	CAN_BS2_8tq
  	CAN_InitStructure.CAN_Prescaler=brp;  //¡¤??¦Ì?¦Ì¨ºy(Fdiv)?abrp+1	
  	if(CAN_InitStatus_Success == CAN_Init(CAN2, &CAN_InitStructure))
			;//printf("init can2: CAN_Init success.\r\n");   // 3?¨º??¡¥CAN1 
		else 
			printf("error -> init can2: CAN_Init fail.\r\n");   // 3?¨º??¡¥CAN1 
    
		//????1y???¡Â ¨º?¨ª¡§1ycan1¨¤¡ä¨¦¨¨??¦Ì?¡ê?????1¡è¡Á¡Â?¡ê¨º?¡ê?2¡§¨¬??¨º¦Ì¨¨?¨¦¨°??¡Â¡Á?¨¦¨¨??
		//¨®D¨¢???can?????¡Â¡ê?can1?¡Â¡ê? can2¡ä¨®¡ê??????????¡Â¨®D¨¨y??¡¤¡é?¨ª¨®¨º??¡ê?¨¢???fifo
		//????fifo¨®D¨¨y???¨®¨º?¨®¨º???¡ê
/* 	  CAN_FilterInitStructure.CAN_FilterNumber=16;	  //1y???¡Â0   ¨°??¡§¨°a¡ä¨®¨®¨²14
  	CAN_FilterInitStructure.CAN_FilterMode=CAN_FilterMode_IdMask; 
  	CAN_FilterInitStructure.CAN_FilterScale=CAN_FilterScale_32bit; //32?? 
  	CAN_FilterInitStructure.CAN_FilterIdHigh=0x0000;////32??ID  0x0000 lex change
  	CAN_FilterInitStructure.CAN_FilterIdLow=0x0000;
  	CAN_FilterInitStructure.CAN_FilterMaskIdHigh=0x0000;//32??MASK
  	CAN_FilterInitStructure.CAN_FilterMaskIdLow=0x0000;
   	CAN_FilterInitStructure.CAN_FilterFIFOAssignment=CAN_Filter_FIFO1;//1y???¡Â01?¨¢a¦Ì?FIFO0  //CAN_Filter_FIFO0
  	CAN_FilterInitStructure.CAN_FilterActivation=ENABLE; //?¡è??1y???¡Â0
  	CAN_FilterInit(&CAN_FilterInitStructure);//??2¡§?¡Â3?¨º??¡¥
*/		
#if CAN2_RX1_INT_ENABLE
	
	  CAN_ITConfig(CAN2, CAN_IT_FMP1/*|CAN_IT_FF1|CAN_IT_FOV1*/, ENABLE);//FIFO1???¡é1¨°o??D???¨ºD¨ª.		    //CAN_IT_FMP0 
    //CAN_IT_FMP1 FIFO 1 message pending Interrupt
		
		//NVIC_SetVectorTable(NVIC_VectTab_RAM, 0x0);//add by lex
		//NVIC_SetVectorTable(NVIC_VectTab_FLASH, 0x0);
  	NVIC_InitStructure.NVIC_IRQChannel = CAN2_RX1_IRQn;  //CAN2_RX0_IRQn ??¨®|FIFO1
  	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2;     // ?¡Â¨®??¨¨???a1
  	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;            // ¡ä?¨®??¨¨???a0
  	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
  	NVIC_Init(&NVIC_InitStructure);
#endif
	return 0;
}   
 
#if CAN2_RX1_INT_ENABLE	//¨º1?¨¹RX0?D??
//?D??¡¤t??o¡¥¨ºy			  
/*	
	printf("\r\n");
	printf("%s->RxMessage.StdId=0x%03x, RxMessage.IDE=0x%x, RxMessage.RTR=0x%x\r\n", 
		__func__, RxMessage.StdId, RxMessage.IDE, RxMessage.RTR);
	//RTR = 1 ¡À¨ª¨º???3¨¬??
	//IDE = 1 ¡À¨ª¨º?¨¤??1??
	//StdId   ID 11bit or 29bit
	printf("data len=%d\r\n", RxMessage.DLC);//data len
	
	for(i=0;i<8;i++)
		printf("%d ", RxMessage.Data[i]);
	printf("\r\n");
*/

long num_can2_IRQ = 0;

void CAN2_RX1_IRQHandler(void) //CAN2_RX0_IRQHandler
{
	CanRxMsg RxMessage;

	struct rfifo *fifo = &canfifo;
	num_can2_IRQ++;

	(void) vPortEnterCritical();
	
	CAN_Receive(CAN2, CAN_FIFO1, &RxMessage);
	
	while( fifo->size - rfifo_len( fifo ) < sizeof(unsigned int) + sizeof(unsigned char)*8 )
	{
		printf("can fifo error!\r\n");
		(void) vPortExitCritical();				
		return;
	}

	if (RxMessage.IDE == CAN_Id_Standard)
	{
		rfifo_put(fifo, &RxMessage.StdId, sizeof(unsigned int));
		rfifo_put(fifo, RxMessage.Data, sizeof(unsigned char)*8);
		if( pxCanTask )
		{
			vTaskNotifyGiveFromISR( pxCanTask, NULL );	
		}		
		
		//xSemaphoreGiveFromISR(xDownStreamSemaphore, NULL);
	}	

	(void) vPortExitCritical();				
		
}
#endif

//can¡¤¡é?¨ª¨°?¡Á¨¦¨ºy?Y(1¨¬?¡§??¨º?:ID?a0X12,¡À¨º¡Á???,¨ºy?Y??)	
//len:¨ºy?Y3¡è?¨¨(¡Á?¡ä¨®?a8)				     
//msg:¨ºy?Y????,¡Á?¡ä¨®?a8??¡Á??¨².
//¡¤¦Ì???¦Ì:0,3¨¦1|;
//		 ????,¨º¡ì¡ã¨¹;
u8 CAN2_Send_Msg(u8* msg,u8 len)
{	
//id:¡À¨º¡Á?ID(11??)/¨¤??1ID(11??+18??)	    
//ide:0,¡À¨º¡Á???;1,¨¤??1??
//rtr:0,¨ºy?Y??;1,??3¨¬??
//len:¨ºy?Y3¡è?¨¨
//msg:¨ºy?Y?o¡ä???	
  u8 mbox;
  u16 i=0;
  CanTxMsg TxMessage;
  TxMessage.StdId=0x12;	 // ¡À¨º¡Á?¡À¨º¨º?¡¤??a0 			11bit   0x712
  TxMessage.ExtId=0x12;	 // ¨¦¨¨??¨¤??1¡À¨º¨º?¡¤?¡ê¡§29??¡ê?
  TxMessage.IDE=0;		  // ¨º1¨®?¨¤??1¡À¨º¨º?¡¤?
  TxMessage.RTR=0;		  // ???¡é¨¤¨¤D¨ª?a¨ºy?Y??¡ê?¨°???8??
  TxMessage.DLC=len;							 // ¡¤¡é?¨ª¨¢???D??¡é
  for(i=0;i<len;i++)
  TxMessage.Data[i]=msg[i];				 // ¦Ì¨²¨°???D??¡é          
  mbox= CAN_Transmit(CAN2, &TxMessage);   
  i=0;
  while((CAN_TransmitStatus(CAN2, mbox)==CAN_TxStatus_Failed)&&(i<0XFFF))i++;	//¦Ì¨¨¡äy¡¤¡é?¨ª?¨¢¨º?
  if(i>=0XFFF)return 1;
  return 0;		

}

u8 CAN2_Send_Msg1(uint32_t id, u8* msg,u8 len)
{	
//id:¡À¨º¡Á?ID(11??)/¨¤??1ID(11??+18??)	    
//ide:0,¡À¨º¡Á???;1,¨¤??1??
//rtr:0,¨ºy?Y??;1,??3¨¬??
//len:¨ºy?Y3¡è?¨¨
//msg:¨ºy?Y?o¡ä???	
  u8 mbox;
  u16 i=0;
  CanTxMsg TxMessage;
  TxMessage.StdId=id;	 // ¡À¨º¡Á?¡À¨º¨º?¡¤??a0 			11bit   0x712
  TxMessage.ExtId=0x12;	 // ¨¦¨¨??¨¤??1¡À¨º¨º?¡¤?¡ê¡§29??¡ê?
  TxMessage.IDE=0;		  // ¨º1¨®?¨¤??1¡À¨º¨º?¡¤?
  TxMessage.RTR=0;		  // ???¡é¨¤¨¤D¨ª?a¨ºy?Y??¡ê?¨°???8??
  TxMessage.DLC=len;							 // ¡¤¡é?¨ª¨¢???D??¡é
  for(i=0;i<len;i++)
  TxMessage.Data[i]=msg[i];				 // ¦Ì¨²¨°???D??¡é          
  mbox= CAN_Transmit(CAN2, &TxMessage);   
  i=0;
  while((CAN_TransmitStatus(CAN2, mbox)==CAN_TxStatus_Failed)&&(i<0XFFF))i++;	//¦Ì¨¨¡äy¡¤¡é?¨ª?¨¢¨º?
  if(i>=0XFFF)return 1;
  return 0;		

}

u8 CAN2_Send_Msg2(uint32_t id, uint8_t ide, uint8_t rtr, u8* msg,u8 len)
{	
//id:¡À¨º¡Á?ID(11??)/¨¤??1ID(11??+18??)	    
//ide:0,¡À¨º¡Á???;1,¨¤??1??
//rtr:0,¨ºy?Y??;1,??3¨¬??
//len:¨ºy?Y3¡è?¨¨
//msg:¨ºy?Y?o¡ä???	
  u8 mbox;
  u16 i=0;
  CanTxMsg TxMessage;
  TxMessage.StdId=id;	 // ¡À¨º¡Á?¡À¨º¨º?¡¤??a0 			11bit   0x712
  TxMessage.ExtId=id;	 // ¨¦¨¨??¨¤??1¡À¨º¨º?¡¤?¡ê¡§29??¡ê?
  TxMessage.IDE=ide;		  // ¨º1¨®?¨¤??1¡À¨º¨º?¡¤?
  TxMessage.RTR=rtr;		  // ???¡é¨¤¨¤D¨ª?a¨ºy?Y??¡ê?¨°???8??
  TxMessage.DLC=len;							 // ¡¤¡é?¨ª¨¢???D??¡é
  for(i=0;i<len;i++)
  TxMessage.Data[i]=msg[i];				 // ¦Ì¨²¨°???D??¡é          
  mbox= CAN_Transmit(CAN2, &TxMessage);   
  i=0;
  while((CAN_TransmitStatus(CAN2, mbox)==CAN_TxStatus_Failed)&&(i<0XFFF))i++;	//¦Ì¨¨¡äy¡¤¡é?¨ª?¨¢¨º?
  if(i>=0XFFF)return 1;
  return 0;		

}
//can?¨²?¨®¨º?¨ºy?Y2¨¦?¡¥
//buf:¨ºy?Y?o¡ä???;	 
//¡¤¦Ì???¦Ì:0,?T¨ºy?Y¡À?¨º?¦Ì?;
//		 ????,?¨®¨º?¦Ì?¨ºy?Y3¡è?¨¨;
u8 CAN2_Receive_Msg(u8 *buf)
{		   		   
 	u32 i;
	CanRxMsg RxMessage;
    if( CAN_MessagePending(CAN2,CAN_FIFO0)==0)return 0;		//??¨®D?¨®¨º?¦Ì?¨ºy?Y,?¡À?¨®¨ª?3? 
    CAN_Receive(CAN2, CAN_FIFO0, &RxMessage);//?¨¢¨¨?¨ºy?Y	
    for(i=0;i<RxMessage.DLC;i++)
    buf[i]=RxMessage.Data[i];  
	return RxMessage.DLC;	
}






